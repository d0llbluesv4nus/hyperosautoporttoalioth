name: HOS to SGSI for Alioth (Patched)

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: '–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ Recovery ROM (.zip) HyperOS/MIUI'
        required: true
        default: ''
      os_type:
        description: '–¢–∏–ø —Å–∏—Å—Ç–µ–º—ã (ab - –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞, a - –¥–ª—è —Å—Ç–∞—Ä—ã—Ö)'
        required: true
        default: 'ab'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —É—Ç–∏–ª–∏—Ç)
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget zip unzip curl axel python3 python3-pip android-sdk-libsparse-utils
          sudo apt-get install -y e2fsprogs simg2img img2simg p7zip-full
          pip3 install protobuf
          
      - name: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (Xiaoxindada)
        run: |
          git clone --recurse-submodules https://github.com/xiaoxindada/sgsi-build-tool.git tool
          sudo chmod -R 777 tool
          
      - name: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø—Ä–æ—à–∏–≤–∫–∏
        run: |
          cd tool
          echo "–°–∫–∞—á–∏–≤–∞–µ–º ROM..."
          axel -n 16 "${{ github.event.inputs.rom_url }}" -o firmware.zip
          unzip firmware.zip -d firmware_extracted
          
          # –ü–æ–∏—Å–∫ payload.bin –∏–ª–∏ br (brotli)
          if [ -f "firmware_extracted/payload.bin" ]; then
            echo "–ù–∞–π–¥–µ–Ω payload.bin, —Ä–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º..."
            # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ payload-dumper-go (–±—ã—Å—Ç—Ä–µ–µ —á–µ–º python)
            wget https://github.com/ssut/payload-dumper-go/releases/download/1.2.2/payload-dumper-go_1.2.2_linux_amd64.tar.gz
            tar -xvf payload-dumper-go_1.2.2_linux_amd64.tar.gz
            ./payload-dumper-go -o firmware_extracted/images firmware_extracted/payload.bin
            mv firmware_extracted/images/system.img .
          else
             echo "Payload.bin –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—â–µ–º system.new.dat.br..."
             # –õ–æ–≥–∏–∫–∞ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –Ω–æ HOS –æ–±—ã—á–Ω–æ –≤ payload)
          fi

      - name: –°–±–æ—Ä–∫–∞ SGSI (–ë–∞–∑–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å)
        run: |
          cd tool
          sudo ./make.sh --${{ github.event.inputs.os_type }} system.img
          echo "–ë–∞–∑–æ–≤–∞—è —Å–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –§–∞–π–ª SGSI.img –≥–æ—Ç–æ–≤ –∫ –ø–∞—Ç—á–∏–Ω–≥—É."

      - name: üõ†Ô∏è –ü–ê–¢–ß–ò–ù–ì (Alioth Specific & General Fixes)
        run: |
          cd tool
          
          # 1. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º sparse image –≤ raw, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å
          if file SGSI.img | grep -q "sparse"; then
            simg2img SGSI.img system_raw.img
            rm SGSI.img
            mv system_raw.img SGSI.img
          fi

          # 2. –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –æ–±—Ä–∞–∑–∞ –¥–ª—è –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π (–¥–æ–±–∞–≤–ª—è–µ–º 200–ú–±)
          e2fsck -f SGSI.img
          resize2fs SGSI.img 4500M || true

          # 3. –ú–æ–Ω—Ç–∏—Ä—É–µ–º
          mkdir -p mount_point
          sudo mount -o loop,rw SGSI.img mount_point

          echo ">>> –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–∞—Ç—á–∏..."

          # --- –ü–ê–¢–ß 1: Debloat (–£–¥–∞–ª–µ–Ω–∏–µ –º—É—Å–æ—Ä–∞, —á—Ç–æ–±—ã –≤–ª–µ–∑–ª–æ –∏ –Ω–µ —Ç–æ—Ä–º–æ–∑–∏–ª–æ) ---
          sudo rm -rf mount_point/system/app/MiVideo
          sudo rm -rf mount_point/system/app/MiMusic
          sudo rm -rf mount_point/system/priv-app/MiBrowserGlobal
          # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

          # --- –ü–ê–¢–ß 2: Build.prop (Spoofing –ø–æ–¥ Alioth) ---
          # –≠—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –º–∞—Ä–∫–µ—Ç–µ –∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã–º –∏–≥—Ä–∞–º –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∫–∞–∫ POCO F3
          sudo sed -i 's/ro.product.model=.*/ro.product.model=M2012K11AC/g' mount_point/system/build.prop
          sudo sed -i 's/ro.product.brand=.*/ro.product.brand=POCO/g' mount_point/system/build.prop
          sudo sed -i 's/ro.product.name=.*/ro.product.name=alioth/g' mount_point/system/build.prop
          sudo sed -i 's/ro.product.device=.*/ro.product.device=alioth/g' mount_point/system/build.prop
          
          # --- –ü–ê–¢–ß 3: Fix DFPS / Overlays (–ï—Å–ª–∏ –µ—Å—Ç—å URL –Ω–∞ –∑–∏–ø —Å –æ–≤–µ—Ä–ª–µ—è–º–∏) ---
          # –î–ª—è Alioth —á–∞—Å—Ç–æ –Ω—É–∂–Ω—ã —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ–≤–µ—Ä–ª–µ–∏ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞.
          # –ó–¥–µ—Å—å –º—ã –∫–∞—á–∞–µ–º —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø–∞—Ç—á, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –∑–∞–≥–ª—É—à–∫—É.
          # –ü—Ä–∏–º–µ—Ä (—Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ä–µ–∞–ª—å–Ω–æ–≥–æ URL):
          # wget https://example.com/alioth_overlay.apk
          # sudo cp alioth_overlay.apk mount_point/system/product/overlay/

          # --- –ü–ê–¢–ß 4: –†–∞–∑—Ä–µ—à–∏—Ç—å –∑–∞–ø–∏—Å—å (RW) –≤ fstab (–µ—Å–ª–∏ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç) ---
          if [ -f "mount_point/system/etc/fstab.qcom" ]; then
             sudo sed -i 's/,ro/,rw/g' mount_point/system/etc/fstab.qcom
          fi

          echo ">>> –ü–∞—Ç—á–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω."

          # 4. –†–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–ø–∞–∫–æ–≤–∫–∞
          sudo umount mount_point
          
          # –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–±—Ä–∞–∑–∞ (shrink)
          resize2fs -M SGSI.img
          
          # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –æ–±—Ä–∞—Ç–Ω–æ –≤ sparse (–¥–ª—è –ø—Ä–æ—à–∏–≤–∫–∏ —á–µ—Ä–µ–∑ fastboot)
          img2simg SGSI.img SGSI_Patched.img

      - name: –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        uses: actions/upload-artifact@v4
        with:
          name: HOS_SGSI_Alioth_Patched
          path: tool/SGSI_Patched.img
