name: Port ROM for Poco F3 (Alioth)

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: 'URL Базовой прошивки (Stock ROM for Alioth)'
        required: true
      port_url:
        description: 'URL Портируемой прошивки (Donor ROM)'
        required: true
      rom_name:
        description: 'Имя выходного архива'
        default: 'HyperOS_Port_Alioth'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Cleanup Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Install Tools & Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y git aria2 python3 python3-pip zip unzip p7zip-full tar zstd brotli
          
          # Установка erofs-utils
          sudo apt-get install -y erofs-utils
          
          # Установка payload-dumper-go
          wget https://github.com/ssut/payload-dumper-go/releases/download/1.2.2/payload-dumper-go_1.2.2_linux_amd64.tar.gz
          tar -xvf payload-dumper-go_1.2.2_linux_amd64.tar.gz
          chmod +x payload-dumper-go
          sudo mv payload-dumper-go /usr/local/bin/

      - name: Download & Extract ROMs
        run: |
          mkdir -p input/base input/port
          mkdir -p workspace/base workspace/port
          
          # --- СКАЧИВАНИЕ ---
          echo "Downloading Base ROM..."
          aria2c -x16 -s16 -d input/base -o base_rom "${{ inputs.base_url }}"
          
          echo "Downloading Port ROM..."
          aria2c -x16 -s16 -d input/port -o port_rom "${{ inputs.port_url }}"
          
          # --- РАСПАКОВКА BASE ---
          echo "Extracting Base..."
          cd input/base
          # Проверяем, это zip или tgz/tar.gz
          if file base_rom | grep -q "Zip archive"; then
              mv base_rom base.zip
              unzip base.zip -d temp/
          elif file base_rom | grep -q "gzip compressed"; then
              mv base_rom base.tgz
              tar -xzvf base.tgz -C temp/
          else
              echo "Unknown format for Base ROM"
              exit 1
          fi
          cd ../..
          
          # Ищем payload или images в Base
          if [ -f input/base/temp/payload.bin ]; then
              payload-dumper-go -o workspace/base input/base/temp/payload.bin
          elif [ -n "$(find input/base/temp -name 'system.img')" ]; then
              echo "Images found directly (Fastboot ROM)"
              find input/base/temp -name '*.img' -exec mv {} workspace/base/ \;
          else
              # Если структура сложная, копируем всё
              cp -r input/base/temp/* workspace/base/
          fi

          # --- РАСПАКОВКА PORT ---
          echo "Extracting Port..."
          cd input/port
          if file port_rom | grep -q "Zip archive"; then
              mv port_rom port.zip
              unzip port.zip -d temp/
          elif file port_rom | grep -q "gzip compressed"; then
              mv port_rom port.tgz
              tar -xzvf port.tgz -C temp/
          fi
          cd ../..
          
          # Ищем payload в Port
          if [ -f input/port/temp/payload.bin ]; then
              payload-dumper-go -o workspace/port input/port/temp/payload.bin
          else
               # Если payload нет, пробуем найти images
              find input/port/temp -name '*.img' -exec mv {} workspace/port/ \;
          fi

      - name: Run Porting Script (ROOT)
        run: |
          if [ ! -f port_script.sh ]; then
            echo "Error: port_script.sh not found!"
            exit 1
          fi
          
          chmod +x port_script.sh
          
          # !!! ВАЖНО: ЗАПУСК ЧЕРЕЗ SUDO !!!
          # Скрипт должен уметь работать с правами root для mount
          sudo ./port_script.sh $(pwd)/workspace/base $(pwd)/workspace/port

      - name: Prepare Output Structure
        run: |
          mkdir -p final_rom
          # Если скрипт (мой исправленный) кладет итог в working/out:
          if [ -d "working/out" ]; then
             cp -r working/out/* final_rom/
             # Копируем boot.img и прочее из базы, если их нет в out
             if [ ! -f final_rom/boot.img ]; then cp workspace/base/boot.img final_rom/ 2>/dev/null || true; fi
             if [ ! -f final_rom/dtbo.img ]; then cp workspace/base/dtbo.img final_rom/ 2>/dev/null || true; fi
             if [ ! -f final_rom/vbmeta.img ]; then cp workspace/base/vbmeta.img final_rom/ 2>/dev/null || true; fi
          else
             # Если скрипт менял файлы "на месте" в workspace/base
             cp -r workspace/base/* final_rom/
          fi

      - name: Compress Output
        run: |
          cd final_rom
          # Удаляем лишние тяжелые файлы, если они не нужны для прошивки (например, исходные system.img.raw если остались)
          rm -f *.raw
          
          echo "Zipping final ROM..."
          zip -r9 ../${{ inputs.rom_name }}.zip .
          cd ..
          ls -lh ${{ inputs.rom_name }}.zip

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.rom_name }}
          path: ${{ inputs.rom_name }}.zip
          compression-level: 0
